---
title: "constructPseudotemporalOrdering.Rmd"
output:
  html_notebook: default
  pdf_document: default
---
```{r setup, include=FALSE, echo=FALSE}
require("knitr")
opts_knit$set(root.dir = "/home/samsl/Pseudotemporal-GRNs")
knitr::opts_chunk$set(echo = TRUE)
```

```{r "Load Libraries", warning=FALSE, include=FALSE, results='hide'}
require(ACTIONet)
require(SingleCellExperiment)
require(Seurat)
require(monocle)
require(ComplexHeatmap)
```

### Load SCE and ACTIONet for a specific cell type
Choose from cell types:
  - Astrocytes: "Ast"
  - Excitatory Neurons: "Ex"
  - Inhibitory Neurons: "In"
  - Microglia: "Mic"
  - Oligodendrocytes: "Oli"
  - Oligodendrocyte Progenitor Cells: "OPC"
```{r "Load Data"}
# Select cell type from list
cell.type = "Ex"
sce.file.name <- paste("/home/samsl/Pseudotemporal-GRNs/data/",cell.type,"_sce.rds",sep="")
ACTIONet.file.name <- paste("/home/samsl/Pseudotemporal-GRNs/data/",cell.type,"_ACTIONet.rds",sep="")
sce <- readRDS(sce.file.name)
ACTIONet.out <- readRDS(ACTIONet.file.name)
```

# Identify Cell States Correlated with Disease
To produce a pseudotemporal ordering of cell states, we identify cell states which are correlated with disease. We can use `braaksc`, `ceradsc`, or `cogdx` as clinical indicators of disease progression. For now, we will use `ceradsc`. We plot enrichment for clinical phenotype across cell states to identify the maximally enriched cell state. This cell state can then be used to assign scores for each cell. Additionally, we can identify genes which are enriched in this cell state as potential ordering genes.
```{r "Find Cluster Markers"}
# Import Clinical Data from ROSMAP
clinical <- read.table("/home/samsl/Pseudotemporal-GRNs/data/Processed_10x_AD_data/ROSMAP_Clinical_2019-05_v3.csv", header = TRUE, sep=",")

cogdx.ind <- factor(unlist(lapply(colData(sce)$projid, function (x) { clinical[which(clinical$projid == x),"cogdx"] })))
braak.ind <- factor(unlist(lapply(colData(sce)$projid, function (x) { clinical[which(clinical$projid == x),"braaksc"] })))
cerad.ind <- factor(unlist(lapply(colData(sce)$projid, function (x) { clinical[which(clinical$projid == x),"ceradsc"] })))

# Annotate ACTIONet with each clinical indicator
ACTIONet.out <- add.cell.annotations(ACTIONet.out, cogdx.ind, annotation.name="cogdx")
ACTIONet.out <- add.cell.annotations(ACTIONet.out, braak.ind, annotation.name="braak")
ACTIONet.out <- add.cell.annotations(ACTIONet.out, cerad.ind, annotation.name="ceradsc")

# Visualize  the clinical indicators in the ACTIONet layout
plot.ACTIONet(ACTIONet.out, labels = braak.ind)

# Identify disease progression enriched archetypes
annot.out <- annotate.archetypes.using.labels(ACTIONet.out, braak.ind, core = TRUE)
Heatmap(annot.out$Enrichment, cluster_rows = FALSE, cluster_columns = FALSE)
```

# Calculate Disease Score
```{r "Disease Score"}
disease.score <- ACTIONet.out$unification.out$H.core[1,]
core.significance <- ACTIONet.out$unification.out$DE.core@assays[["significance"]]
associated.genes <- rownames(core.significance)[order(core.significance[,4], decreasing=TRUE)]
plot.ACTIONet.gradient(ACTIONet.out,disease.score)

ACTIONet.out <- cluster.ACTIONet.using.decomposition(ACTIONet.out, annotation.name="CellStateClusters")
plot.ACTIONet(ACTIONet.out, labels = ACTIONet.out$annotations$CellStateClusters$Labels, transparency.attr = ACTIONet.out$annotations$CellStateClusters$Labels.confidence)
```

# Biological Pathway Enrichment
Finally, we can verify the correlation of this cell state with progression by searching for enrichment with GO pathways.
```{r "Pathway Enrichment"}
data("nanoStringDB_human")
ADmarkers <- nanoStringDB_human$AD
enrichment.out <- t(geneset.enrichment.archetype(ACTIONet.out, ADmarkers))
Heatmap(enrichment.out, cluster_rows=FALSE)

data("gProfilerDB_human")
gpADmarkers <- gProfilerDB_human$SYMBOL$`GO:BP`
enrichment.out <- geneset.enrichment.archetype(ACTIONet.out, gpADmarkers)
Heatmap(enrichment.out, cluster_rows=FALSE)
```


# Monocle
```{r Monocle}

```

# Subset Cells
Get only the cells from the subcluster that you want, using only the marker genes. Do this for each subcluster to get the layers.
```{r Subset}
noAD <- as.matrix(counts(sce[unlist(top.markers),which(ACTIONet.out$annotations$ceradsc$Labels == 4)]))
possibleAD <- as.matrix(counts(sce[unlist(top.markers),which(ACTIONet.out$annotations$ceradsc$Labels == 3)]))
probableAD <- as.matrix(counts(sce[unlist(top.markers),which(ACTIONet.out$annotations$ceradsc$Labels == 2)]))
definiteAD <- as.matrix(counts(sce[unlist(top.markers),which(ACTIONet.out$annotations$ceradsc$Labels == 1)]))

saveRDS(noAD, paste("data/noAD_",cell.type,".rds",sep=""))
saveRDS(possibleAD, paste("data/possibleAD_",cell.type,".rds",sep=""))
saveRDS(probableAD, paste("data/probableAD_",cell.type,".rds",sep=""))
saveRDS(definiteAD, paste("data/definiteAD_",cell.type,".rds",sep=""))
```